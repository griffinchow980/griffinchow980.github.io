---
title: "Excel"
date: 2024-10-05
---

# Excel常用函数

{{< details "**如何使用VLOOKUP和XLOOKUP进行数据查找？**" "Excel" >}}

VLOOKUP和XLOOKUP是Excel中最常用的查找函数，用于从表格中匹配数据。

**VLOOKUP基础**：

```excel
=VLOOKUP(查找值, 查找范围, 返回列号, [精确/近似匹配])

示例：
=VLOOKUP(A2, $D$2:$F$10, 3, FALSE)
```

**参数说明**：
- **查找值**：要查找的值（如员工编号、产品ID）
- **查找范围**：包含查找值和返回值的区域
- **返回列号**：从查找范围左侧开始的列序号
- **精确/近似匹配**：
  - `FALSE`或`0`：精确匹配（推荐）
  - `TRUE`或`1`：近似匹配（需排序）

**实战场景**：

{{< tabs "基础查找,防错处理,多条件查找" >}}

**场景1：根据员工编号查找姓名**

表格结构：
```
A列: 订单编号    B列: 员工编号    C列: 姓名(需查找)

查找表：
D列: 员工编号    E列: 姓名    F列: 部门
```

公式：
```excel
=VLOOKUP(B2, $D$2:$F$100, 2, FALSE)
```

|||

**场景2：防止出错（IFERROR包裹）**

问题：查找不到时显示#N/A错误

解决：
```excel
=IFERROR(VLOOKUP(B2, $D$2:$F$100, 2, FALSE), "未找到")

或使用IF+ISNA：
=IF(ISNA(VLOOKUP(B2, $D$2:$F$100, 2, FALSE)), "未找到", VLOOKUP(B2, $D$2:$F$100, 2, FALSE))
```

|||

**场景3：多条件查找（辅助列）**

需求：同时匹配部门和员工编号

步骤1：创建辅助列
```excel
# 在查找表新增列G（辅助列）
=D2&"-"&E2    # 合并部门和编号
```

步骤2：使用VLOOKUP查找
```excel
=VLOOKUP(A2&"-"&B2, $G$2:$H$100, 2, FALSE)
```

{{< /tabs >}}

**XLOOKUP优势**（Excel 365/2021）：

```excel
=XLOOKUP(查找值, 查找数组, 返回数组, [找不到的返回值], [匹配模式], [搜索模式])

示例：
=XLOOKUP(A2, $D$2:$D$100, $E$2:$E$100, "未找到", 0)
```

**XLOOKUP vs VLOOKUP对比**：

| 特性 | VLOOKUP | XLOOKUP |
|------|---------|---------|
| 查找方向 | 只能向右查找 | 任意方向 |
| 列号变化 | 需手动调整列号 | 自动适应 |
| 默认错误 | 显示#N/A | 可自定义 |
| 多条件 | 需辅助列 | 直接支持 |
| 性能 | 较慢 | 更快 |

**XLOOKUP实战**：

```excel
# 1. 反向查找（向左查找）
=XLOOKUP(A2, $E$2:$E$100, $D$2:$D$100)

# 2. 查找最后一个匹配项
=XLOOKUP(A2, $D$2:$D$100, $E$2:$E$100, , 0, -1)

# 3. 返回多列
=XLOOKUP(A2, $D$2:$D$100, $E$2:$G$100)

# 4. 近似匹配（成绩等级）
=XLOOKUP(A2, {0,60,70,80,90}, {"不及格","及格","中等","良好","优秀"}, , 1)
```

**常见错误处理**：

```excel
# 1. 查找范围未锁定
❌ =VLOOKUP(A2, D2:F100, 2, FALSE)    # 向下拖动公式时范围会变
✅ =VLOOKUP(A2, $D$2:$F$100, 2, FALSE) # 使用绝对引用

# 2. 数据类型不匹配
# 问题：文本"001"无法匹配数字1
# 解决：统一类型
=VLOOKUP(TEXT(A2,"000"), $D$2:$F$100, 2, FALSE)
或
=VLOOKUP(VALUE(A2), $D$2:$F$100, 2, FALSE)

# 3. 空格导致无法匹配
=VLOOKUP(TRIM(A2), $D$2:$F$100, 2, FALSE)
```

**性能优化技巧**：

1. **使用精确匹配**：`FALSE`比`TRUE`更快
2. **限制查找范围**：只包含必要列
3. **避免跨表查找**：整理到同一工作表
4. **使用INDEX+MATCH替代**（大数据量）：
   ```excel
   =INDEX($E$2:$E$100, MATCH(A2, $D$2:$D$100, 0))
   ```

{{< /details >}}

{{< details "**如何使用IF和IFS进行条件判断？**" "Excel" >}}

IF函数是Excel逻辑判断的核心，用于根据条件返回不同结果。

**IF函数基础**：

```excel
=IF(条件, 真值, 假值)

示例：
=IF(A2>=60, "及格", "不及格")
```

**嵌套IF（多条件）**：

```excel
# 成绩等级划分
=IF(A2>=90, "优秀", IF(A2>=80, "良好", IF(A2>=70, "中等", IF(A2>=60, "及格", "不及格"))))

# 更清晰的写法（按Alt+Enter换行）
=IF(A2>=90, "优秀",
  IF(A2>=80, "良好",
    IF(A2>=70, "中等",
      IF(A2>=60, "及格", "不及格"))))
```

**IFS函数**（Excel 2019+，更简洁）：

```excel
=IFS(
    条件1, 结果1,
    条件2, 结果2,
    条件3, 结果3,
    TRUE, 默认结果
)

示例：
=IFS(
    A2>=90, "优秀",
    A2>=80, "良好",
    A2>=70, "中等",
    A2>=60, "及格",
    TRUE, "不及格"
)
```

**实战场景**：

{{< tabs "单条件,多条件AND,多条件OR,复杂逻辑" >}}

**场景1：薪资等级判断**

```excel
# 基础判断
=IF(B2>10000, "高薪", "普通")

# 带阈值
=IF(B2>=15000, "A级", IF(B2>=10000, "B级", IF(B2>=7000, "C级", "D级")))

# IFS版本（推荐）
=IFS(
    B2>=15000, "A级",
    B2>=10000, "B级",
    B2>=7000, "C级",
    TRUE, "D级"
)
```

|||

**场景2：多条件AND组合**

需求：年龄>=25且工资>=8000才是"目标人群"

```excel
# 方法1：嵌套IF
=IF(AND(B2>=25, C2>=8000), "目标人群", "非目标")

# 方法2：乘法（更简洁）
=IF((B2>=25)*(C2>=8000), "目标人群", "非目标")

# 方法3：IFS（多目标分级）
=IFS(
    AND(B2>=25, C2>=10000), "优质",
    AND(B2>=25, C2>=8000), "目标",
    TRUE, "非目标"
)
```

|||

**场景3：多条件OR组合**

需求：VIP或消费>5000元可享受折扣

```excel
# 方法1：OR函数
=IF(OR(B2="VIP", C2>5000), "9折", "原价")

# 方法2：加法
=IF((B2="VIP")+(C2>5000), "9折", "原价")

# 方法3：复杂OR+AND
=IF(OR(B2="VIP", AND(C2>5000, D2>3)), "8折", "9折")
```

|||

**场景4：包含文本判断**

```excel
# 检查是否包含关键词
=IF(ISNUMBER(SEARCH("北京", A2)), "一线", "其他")

# 多关键词检查
=IF(OR(ISNUMBER(SEARCH("北京", A2)), ISNUMBER(SEARCH("上海", A2)), ISNUMBER(SEARCH("广州", A2))), "一线", "其他")

# 排除某些值
=IF(OR(A2="", A2="N/A", A2="无"), "缺失", A2)
```

{{< /tabs >}}

**常用组合函数**：

```excel
# 1. IF + ISBLANK（空值判断）
=IF(ISBLANK(A2), "未填写", A2)

# 2. IF + ISERROR（错误处理）
=IF(ISERROR(A2/B2), 0, A2/B2)

# 3. IF + COUNTIF（唯一性检查）
=IF(COUNTIF($A$2:A2, A2)>1, "重复", "唯一")

# 4. IF + LEN（长度验证）
=IF(LEN(A2)=11, "手机号正确", "手机号错误")

# 5. IF + WEEKDAY（工作日判断）
=IF(OR(WEEKDAY(A2)=1, WEEKDAY(A2)=7), "周末", "工作日")

# 6. IF + MONTH（月份判断）
=IF(MONTH(A2)<=6, "上半年", "下半年")
```

**高级技巧**：

**1. 区间判断（嵌套AND）**

```excel
# 判断年龄是否在18-35岁之间
=IF(AND(A2>=18, A2<=35), "符合", "不符合")

# 多区间判断
=IFS(
    A2<18, "未成年",
    AND(A2>=18, A2<=35), "青年",
    AND(A2>35, A2<=60), "中年",
    A2>60, "老年"
)
```

**2. 动态阈值**

```excel
# 根据部门设置不同及格线
=IF(B2="销售", IF(C2>=8000, "达标", "未达标"), IF(C2>=5000, "达标", "未达标"))

# 使用VLOOKUP动态查找阈值
=IF(C2>=VLOOKUP(B2, $E$2:$F$10, 2, FALSE), "达标", "未达标")
```

**3. 优先级判断**

```excel
# 多个奖励规则，取最高等级
=IFS(
    A2>=90, "特等奖",
    A2>=80, "一等奖",
    A2>=70, "二等奖",
    A2>=60, "三等奖",
    TRUE, "无奖励"
)
```

**4. 组合计算**

```excel
# 根据条件计算不同公式
=IF(A2="固定", B2*1000, IF(A2="提成", B2*0.1*C2, B2*500))

# 带折扣的价格计算
=IF(B2="VIP", A2*0.8, IF(B2="会员", A2*0.9, A2))
```

**性能优化**：

1. **避免过深嵌套**：超过3层考虑用IFS或SWITCH
2. **简化逻辑**：能用数学运算代替IF就不用IF
   ```excel
   # 慢
   =IF(A2>0, 1, 0)
   # 快
   =(A2>0)*1
   ```
3. **提前计算**：复杂条件先用辅助列计算，再判断

**常见错误**：

❌ `=IF(A2>60, "及格")`  # 缺少假值参数
✅ `=IF(A2>60, "及格", "不及格")`

❌ `=IF(A2="VIP" OR B2>5000, "优惠", "原价")`  # 语法错误
✅ `=IF(OR(A2="VIP", B2>5000), "优惠", "原价")`

❌ `=IF(AND(A2>60, <80), "中等", "其他")`  # 不完整表达式
✅ `=IF(AND(A2>60, A2<80), "中等", "其他")`

{{< /details >}}

{{< details "**如何使用SUMIF、SUMIFS进行条件求和？**" "Excel" >}}

条件求和是数据分析中的常用操作，用于按条件汇总数据。

**SUMIF：单条件求和**：

```excel
=SUMIF(条件区域, 条件, [求和区域])

示例：
=SUMIF(B:B, "北京", C:C)    # B列是"北京"的行，对应C列求和
```

**参数说明**：
- **条件区域**：判断条件的单元格区域
- **条件**：筛选条件（可以是数字、文本、表达式）
- **求和区域**：实际求和的单元格区域（可省略，则对条件区域求和）

**常用条件格式**：

```excel
# 1. 等于
=SUMIF(A:A, "北京", B:B)
=SUMIF(A:A, "="&D2, B:B)     # 引用单元格

# 2. 大于/小于
=SUMIF(B:B, ">1000", C:C)
=SUMIF(B:B, "<="&D2, C:C)    # 引用单元格阈值

# 3. 不等于
=SUMIF(A:A, "<>北京", B:B)

# 4. 通配符
=SUMIF(A:A, "北京*", B:B)    # 以"北京"开头
=SUMIF(A:A, "*公司", B:B)    # 以"公司"结尾
=SUMIF(A:A, "*销售*", B:B)   # 包含"销售"

# 5. 日期条件
=SUMIF(A:A, ">=2024-01-01", B:B)
=SUMIF(A:A, ">="&DATE(2024,1,1), B:B)
```

**SUMIFS：多条件求和**：

```excel
=SUMIFS(求和区域, 条件区域1, 条件1, 条件区域2, 条件2, ...)

示例：
=SUMIFS(D:D, B:B, "北京", C:C, ">1000")
# 求和D列，条件：B列="北京" 且 C列>1000
```

**实战场景**：

{{< tabs "单条件统计,多条件交叉,日期范围,动态条件" >}}

**场景1：部门销售额统计**

数据结构：
```
A列: 日期    B列: 部门    C列: 销售员    D列: 销售额
```

```excel
# 统计销售部总销售额
=SUMIF(B:B, "销售部", D:D)

# 统计特定销售员业绩
=SUMIF(C:C, "张三", D:D)

# 统计大额订单（>5000）
=SUMIF(D:D, ">5000")        # 省略求和区域，对D列自身求和
=SUMIF(D:D, ">5000", D:D)   # 完整写法

# 引用单元格条件
=SUMIF(B:B, F2, D:D)        # F2单元格填写"销售部"
=SUMIF(D:D, ">"&G2, D:D)    # G2单元格填写阈值5000
```

|||

**场景2：多维度交叉统计**

```excel
# 销售部且销售额>5000
=SUMIFS(D:D, B:B, "销售部", D:D, ">5000")

# 北京地区的VIP客户消费
=SUMIFS(E:E, B:B, "北京", C:C, "VIP")

# 销售部张三的大额订单
=SUMIFS(D:D, B:B, "销售部", C:C, "张三", D:D, ">=5000")

# 排除某些值
=SUMIFS(D:D, B:B, "<>销售部", C:C, "<>退货")
```

|||

**场景3：日期范围统计**

```excel
# 某月销售额
=SUMIFS(D:D, A:A, ">=2024-01-01", A:A, "<=2024-01-31")

# 使用DATE函数
=SUMIFS(D:D, A:A, ">="&DATE(2024,1,1), A:A, "<="&DATE(2024,1,31))

# 本月销售额（动态）
=SUMIFS(D:D, A:A, ">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1), A:A, "<="&EOMONTH(TODAY(),0))

# 近30天销售额
=SUMIFS(D:D, A:A, ">="&TODAY()-30, A:A, "<="&TODAY())

# 本年度销售额
=SUMIFS(D:D, A:A, ">="&DATE(YEAR(TODAY()),1,1), A:A, "<="&DATE(YEAR(TODAY()),12,31))

# 上个月销售额
=SUMIFS(D:D, A:A, ">="&DATE(YEAR(EOMONTH(TODAY(),-1)),MONTH(EOMONTH(TODAY(),-1)),1), A:A, "<="&EOMONTH(TODAY(),-1))
```

|||

**场景4：动态条件和通配符**

```excel
# 包含特定关键词
=SUMIF(B:B, "*电子*", D:D)              # 包含"电子"
=SUMIF(B:B, "北京*", D:D)               # 以"北京"开头
=SUMIF(C:C, "*?公司", D:D)              # ?代表单个字符

# 多关键词求和（OR逻辑）
=SUMIF(B:B, "*北京*", D:D) + SUMIF(B:B, "*上海*", D:D) + SUMIF(B:B, "*广州*", D:D)

# 根据单元格动态条件
=SUMIF(B:B, "*"&F2&"*", D:D)            # F2输入关键词

# 复杂文本条件
=SUMIFS(D:D, B:B, "*电子*", C:C, "*有限公司")
```

{{< /tabs >}}

**高级应用**：

**1. 跨表求和**

```excel
# 汇总多个工作表
=SUMIF(Sheet1!B:B, "北京", Sheet1!D:D) + SUMIF(Sheet2!B:B, "北京", Sheet2!D:D)

# 使用3D引用（相同结构的多表）
=SUM(SUMIF(Sheet1:Sheet3!B:B, "北京", Sheet1:Sheet3!D:D))
```

**2. 数组条件（多值匹配）**

```excel
# 求和多个部门（需Ctrl+Shift+Enter，或Office 365自动）
=SUM(SUMIF(B:B, {"销售部","市场部","技术部"}, D:D))

# 或使用辅助列标记
新增列E：=IF(OR(B2="销售部", B2="市场部", B2="技术部"), "目标部门", "")
求和：=SUMIF(E:E, "目标部门", D:D)
```

**3. 去重求和**

```excel
# 对唯一值求和（假设B列有重复，求D列唯一行的和）
=SUMPRODUCT((B2:B100<>"")/COUNTIF(B2:B100, B2:B100&""), D2:D100)

# 简单场景：用SUMIF去重
在辅助列：=IF(COUNTIF($B$2:B2, B2)=1, D2, 0)
求和：=SUM(辅助列)
```

**4. 按颜色求和**（需VBA）

```vba
Function SumByColor(rColor As Range, rRange As Range) As Double
    Dim cell As Range
    Dim total As Double
    total = 0
    
    For Each cell In rRange
        If cell.Interior.Color = rColor.Interior.Color Then
            total = total + cell.Value
        End If
    Next cell
    
    SumByColor = total
End Function

' 使用：=SumByColor(A1, B:B)  # A1是参考颜色单元格
```

**性能优化**：

```excel
# 1. 限定范围而非整列
# 慢
=SUMIF(B:B, "北京", D:D)
# 快
=SUMIF(B2:B1000, "北京", D2:D1000)

# 2. 使用SUMPRODUCT替代多个SUMIF（大数据）
=SUMPRODUCT((B2:B1000="北京")*(D2:D1000))

# 3. 复杂条件用数据透视表或辅助列
```

**常见错误**：

❌ `=SUMIF(B:B, 北京, D:D)`  # 文本条件未加引号
✅ `=SUMIF(B:B, "北京", D:D)`

❌ `=SUMIF(B:B, ">1000", D:D)`  # 数字条件加了引号仍可能出错
✅ `=SUMIF(B:B, ">1000", D:D)` 或 `=SUMIF(B:B, ">"&1000, D:D)`

❌ `=SUMIFS(B:B, "北京", D:D)`  # SUMIFS参数顺序错误
✅ `=SUMIFS(D:D, B:B, "北京")`

❌ `=SUMIF(B:B, F2, D:D)` 但F2是数字  # 类型不匹配
✅ 确保F2与B列数据类型一致，或使用TEXT/VALUE转换

{{< /details >}}

# Excel数据分析技巧

{{< details "**如何使用数据透视表进行多维分析？**" "Excel" >}}

数据透视表是Excel最强大的数据分析工具，可以快速汇总和分析大量数据。

**创建数据透视表**：

1. 选中数据区域（包含标题行）
2. 插入 → 数据透视表
3. 选择放置位置（新工作表/现有工作表）
4. 拖拽字段到四个区域

**四个区域作用**：
- **筛选器**：页面级筛选
- **列**：水平分类
- **行**：垂直分类
- **值**：汇总计算

**实战场景**：

{{< tabs "基础汇总,多维分析,计算字段,切片器" >}}

**场景1：销售额基础汇总**

数据结构：
```
日期 | 地区 | 产品 | 销售员 | 销售额 | 成本
```

步骤：
1. 创建数据透视表
2. 将"地区"拖到行
3. 将"销售额"拖到值
4. 右键"销售额" → 值字段设置 → 选择"求和"

结果：
```
地区      销售额总计
北京      150000
上海      200000
广州      180000
总计      530000
```

|||

**场景2：多维交叉分析**

配置：
- **行**：地区
- **列**：产品类别
- **值**：销售额（求和）
- **筛选器**：日期（按月/季度）

结果矩阵：
```
         手机    电脑    平板    总计
北京     50000   60000   40000   150000
上海     70000   80000   50000   200000
广州     60000   70000   50000   180000
总计     180000  210000  140000  530000
```

|||

**场景3：计算字段**

需求：计算利润和利润率

步骤：
1. 在数据透视表中右键
2. 字段、项目和集 → 计算字段
3. 创建新字段"利润" = 销售额 - 成本
4. 创建"利润率" = 利润 / 销售额

|||

**场景4：添加切片器**

步骤：
1. 选中数据透视表
2. 数据透视表分析 → 插入切片器
3. 选择"地区"、"产品"等字段
4. 点击切片器按钮快速筛选

优势：可视化筛选，支持多选，可跨表联动

{{< /tabs >}}

**值汇总方式**：

右键值字段 → 值字段设置：
- **求和**：总销售额
- **计数**：订单数量
- **平均值**：平均订单金额
- **最大值/最小值**：峰值
- **标准偏差**：波动性
- **百分比**：
  - 占总计的百分比
  - 占列/行汇总的百分比
  - 占父项的百分比

**显示方式**：

值显示方式选项：
- **差异**：与基准的差值
- **% 差异**：与基准的百分比差异
- **累计**：累计求和
- **排名**：从大到小排序
- **占比**：占总计/小计的百分比

**分组功能**：

**1. 日期分组**：
右键日期字段 → 组合：
- 按月/季度/年
- 自定义起止日期

**2. 数值分组**：
右键数值字段 → 组合：
- 设置起始值、终止值、步长
- 例：年龄分组（0-20, 20-40, 40-60, 60+）

**3. 文本分组**：
手动选择多个项 → 右键 → 组合
- 例：将"北京"、"上海"、"广州"组合为"一线城市"

**条件格式**：

在数据透视表中应用条件格式：
1. 选中数值区域
2. 条件格式 → 色阶/数据条/图标集

常用场景：
- **色阶**：热力图显示销售分布
- **数据条**：可视化对比大小
- **图标集**：标记增长趋势（↑↓）

**高级技巧**：

**1. 父子项展开**：
- 双击任意汇总值 → 自动生成明细表
- 展示该组的原始记录

**2. 获取数据**：
使用GETPIVOTDATA函数：
```excel
=GETPIVOTDATA("销售额", $A$3, "地区", "北京", "产品", "手机")
# 从A3位置的透视表提取北京地区手机的销售额
```

**3. 多数据源合并**：
- 数据 → 获取数据 → 合并查询
- 或使用Power Query整合多表

**4. 数据模型**：
- 数据 → 数据模型 → 添加到数据模型
- 支持多表关联，类似SQL JOIN
- 可创建DAX计算列

**5. 时间智能**：
添加计算字段：
```excel
# 同比增长
=(销售额 - CALCULATE(销售额, DATEADD(日期, -1, YEAR))) / CALCULATE(销售额, DATEADD(日期, -1, YEAR))

# 环比增长（需Power Pivot）
=(销售额 - CALCULATE(销售额, DATEADD(日期, -1, MONTH))) / CALCULATE(销售额, DATEADD(日期, -1, MONTH))
```

**实战案例：销售仪表板**：

配置多个数据透视表：

**1. 总览表**：
- 行：无
- 列：无
- 值：总销售额、订单数、平均订单

**2. 趋势表**：
- 行：日期（按月）
- 列：无
- 值：销售额
- 显示：累计

**3. 排行榜**：
- 行：销售员
- 列：无
- 值：销售额
- 排序：降序
- 显示：Top 10

**4. 区域分布**：
- 行：地区
- 列：产品类别
- 值：销售额
- 格式：占比

**5. 客户分析**：
- 行：客户等级（RFM分组）
- 列：无
- 值：客户数、平均消费
- 图表：饼图

**性能优化**：

1. **限制数据源大小**：过滤无用记录
2. **避免过多计算字段**：预处理后再透视
3. **使用数据模型**：大数据集启用数据模型
4. **定期刷新**：右键 → 刷新，或设置自动刷新
5. **禁用自动格式**：数据透视表选项 → 取消"自动调整列宽"

**常见问题**：

❌ 数据源有空行/空列 → 清理后重建
❌ 日期无法分组 → 检查格式，统一为日期类型
❌ 求和显示为计数 → 检查数值列是否包含文本
❌ 刷新后格式丢失 → 设置"更新时保留格式"
❌ 切片器不联动 → 右键切片器 → 报表连接 → 勾选目标透视表

{{< /details >}}

{{< details "**如何使用条件格式实现数据可视化？**" "Excel" >}}

条件格式可以根据单元格值自动应用格式，直观展示数据特征。

**基础条件格式**：

路径：开始 → 条件格式

常用类型：
1. **突出显示单元格规则**
2. **项目选取规则**
3. **数据条**
4. **色阶**
5. **图标集**

**实战场景**：

{{< tabs "数值高亮,排名标记,趋势可视化,自定义规则" >}}

**场景1：数值高亮**

目标：标记销售额>10000的单元格为绿色

步骤：
1. 选中数据区域（B2:B100）
2. 条件格式 → 突出显示单元格规则 → 大于
3. 输入 10000
4. 选择格式（绿填充色）

进阶：分段高亮
```
销售额 >= 15000  →  深绿色
销售额 >= 10000  →  浅绿色
销售额 >= 5000   →  黄色
销售额 < 5000    →  红色
```

|||

**场景2：Top N标记**

目标：标记前10名销售员

步骤：
1. 选中销售额列
2. 条件格式 → 项目选取规则 → 前10项
3. 输入 10
4. 选择格式（金色填充）

或：最后10项（后10名）
或：高于/低于平均值

|||

**场景3：趋势可视化**

**数据条**：
- 选中数值列
- 条件格式 → 数据条 → 渐变填充/实心填充
- 自动在单元格中显示横向条形图

**色阶**：
- 2色色阶：低值→高值（如红→绿）
- 3色色阶：低→中→高（如红→黄→绿）

**图标集**：
- 3个图标：箭头（↑↓）、交通灯（●）、旗标
- 4个图标：评级
- 5个图标：星级评分

|||

**场景4：自定义公式规则**

**隔行填色**：
```excel
选中区域：A2:E100
条件格式 → 新建规则 → 使用公式确定格式
公式：=MOD(ROW(),2)=0
格式：浅灰色填充
```

**标记重复值**：
```excel
公式：=COUNTIF($A$2:$A$100, A2)>1
格式：红色填充
```

**标记周末日期**：
```excel
公式：=OR(WEEKDAY(A2)=1, WEEKDAY(A2)=7)
格式：浅蓝色填充
```

**标记空值**：
```excel
公式：=ISBLANK(A2)
格式：黄色填充+红色字体
```

**标记超期任务**（日期列）：
```excel
公式：=AND(A2<TODAY(), B2="未完成")
格式：红色填充
```

**多条件综合**：
```excel
# 高优先级且超期
公式：=AND(C2="高", A2<TODAY(), B2<>"已完成")
格式：深红色填充+白色粗体
```

{{< /tabs >}}

**高级应用**：

**1. 甘特图效果**：

数据结构：
```
A列: 任务    B列: 开始日期    C列: 完成日期
```

步骤：
1. 在D列开始创建日期序列（每列一天）
2. 选中日期区域
3. 条件格式 → 新建规则 → 使用公式
4. 公式：`=AND(D$1>=$B2, D$1<=$C2)`
5. 格式：蓝色填充

结果：自动根据日期范围填充单元格

**2. 热力图**：

场景：销售员×产品的销售矩阵

步骤：
1. 选中数值区域
2. 条件格式 → 色阶 → 更多规则
3. 设置最小值（红）、中间值（黄）、最大值（绿）
4. 类型：百分位数或数值

**3. 进度条**：

公式版进度条：
```excel
# A列：实际完成    B列：目标    C列：进度条
C2公式：=REPT("█", INT(A2/B2*10))&REPT("▁", 10-INT(A2/B2*10))
```

条件格式版：
- 在单元格显示完成百分比
- 条件格式 → 数据条（仅显示条）

**4. 到期提醒**：

```excel
# 未来7天到期：橙色
=AND(A2>=TODAY(), A2<=TODAY()+7)

# 已过期：红色
=AND(A2<TODAY(), B2<>"已完成")

# 今天到期：黄色闪烁
=A2=TODAY()
```

**5. 动态范围高亮**：

需求：根据下拉选择高亮整行

步骤：
1. 在F1创建下拉列表（数据验证）
2. 选中数据区域A2:E100
3. 条件格式 → 新建规则
4. 公式：`=$B2=$F$1`  （B列为匹配列）
5. 格式：黄色填充

**6. 重复值分析**：

**唯一值**：
```excel
=COUNTIF($A$2:$A$100, A2)=1
格式：绿色
```

**首次出现**：
```excel
=COUNTIF($A$2:A2, A2)=1
格式：蓝色
```

**重复值**：
```excel
=COUNTIF($A$2:$A$100, A2)>1
格式：红色
```

**7. 对比列差异**：

```excel
# 标记A列和B列不同的行
=$A2<>$B2
格式：黄色背景
```

**8. 数据质量检查**：

**包含特殊字符**：
```excel
=ISNUMBER(SEARCH("*", A2))+ISNUMBER(SEARCH("?", A2))>0
```

**长度异常**（如手机号）：
```excel
=LEN(A2)<>11
```

**包含空格**：
```excel
=LEN(A2)<>LEN(TRIM(A2))
```

**管理条件格式**：

1. **查看所有规则**：
   - 条件格式 → 管理规则
   - 显示：当前选定区域/整个工作表

2. **规则优先级**：
   - 上面的规则优先
   - 可拖动调整顺序

3. **停止后续规则**：
   - 勾选"如果为真则停止"
   - 防止规则冲突

4. **清除格式**：
   - 条件格式 → 清除规则 → 清除所选单元格/整张表

**性能优化**：

1. **限定范围**：不要整列应用（A:A → A2:A1000）
2. **减少公式规则**：能用内置规则就不用公式
3. **简化公式**：避免SUMIF、VLOOKUP等复杂函数
4. **合并规则**：多个相似规则用一个+公式判断

**常见问题**：

❌ 规则不生效 → 检查单元格是否有其他格式覆盖
❌ 复制后格式不跟随 → 选择性粘贴 → 格式
❌ 公式引用错误 → 注意绝对引用($)使用
❌ 规则过多导致卡顿 → 清理无用规则，简化公式

{{< /details >}}

{{< details "**如何使用Power Query进行数据清洗？**" "Excel" >}}

Power Query是Excel强大的数据整合与清洗工具，可自动化处理重复性数据任务。

**启动Power Query**：

数据 → 获取数据 → 从文件/其他来源

或：
数据 → 从表格/区域（将当前数据加载到Power Query）

**Power Query编辑器**：

主要功能区：
- **主页**：常用转换操作
- **转换**：数据类型、拆分、合并
- **添加列**：基于现有列计算
- **视图**：查询设置、公式栏

**实战场景**：

{{< tabs "数据清洗,列操作,合并追加,分组汇总" >}}

**场景1：基础数据清洗**

常见问题：
- 首行非标题
- 数据类型错误
- 包含空行/空列
- 有多余空格

步骤：
1. 加载数据到Power Query
2. **首行提升为标题**：主页 → 将第一行用作标题
3. **删除空行**：主页 → 删除行 → 删除空行
4. **删除列**：选中列 → 右键 → 删除
5. **修剪空格**：选中文本列 → 转换 → 格式 → 修剪
6. **更改数据类型**：选中列 → 右键 → 更改类型

示例：清洗客户数据
```
原始：
  姓名     年龄   电话
  张三    25     1380000****
  李四    30      1390000****  
  (空行)
  王五    abc    1400000****

清洗后：
姓名    年龄    电话
张三    25      13800000000
李四    30      13900000000
王五    (null)  14000000000

步骤：
1. 删除空行
2. 修剪空格
3. 年龄列：类型改为整数，错误替换为null
4. 电话列：替换值"****"→完整号码（使用替换值功能）
```

|||

**场景2：拆分与合并列**

**拆分列**：

示例：姓名列拆分为姓和名
```
原始：张三
目标：姓=张，名=三

步骤：
1. 选中"姓名"列
2. 转换 → 拆分列 → 按字符数
3. 输入 1（第一个字符后拆分）
4. 重命名列：姓、名
```

按分隔符拆分：
```
原始：北京-朝阳区
步骤：
1. 选中列
2. 拆分列 → 按分隔符 → 选择"-"
3. 拆分选项：在每次出现分隔符时
```

**合并列**：

示例：合并省市区
```
原始：省=北京，市=北京市，区=朝阳区
目标：完整地址=北京北京市朝阳区

步骤：
1. 选中"省"、"市"、"区"三列（按Ctrl多选）
2. 转换 → 合并列
3. 分隔符：无（或自定义如"-"）
4. 新列名：完整地址
```

|||

**场景3：合并多个文件**

需求：合并文件夹中所有Excel文件

步骤：
1. 数据 → 获取数据 → 从文件 → 从文件夹
2. 选择包含Excel文件的文件夹
3. 点击"合并和加载" → 合并工作表
4. 选择要合并的工作表（如Sheet1）
5. Power Query自动识别列
6. 删除不需要的元数据列（如"Source.Name"）
7. 关闭并加载

进阶：追加不同结构的表
```
表1：姓名、年龄、部门
表2：姓名、年龄、城市

步骤：
1. 分别加载两表
2. 主页 → 追加查询 → 三个或更多表
3. 选择表1、表2
4. 结果：共有列自动匹配，独有列保留（其他表此列为null）
```

|||

**场景4：分组聚合**

需求：按部门统计平均工资和人数

步骤：
1. 加载员工表
2. 转换 → 分组依据
3. 分组列：部门
4. 新列名"平均工资"：操作=平均值，列=工资
5. 添加聚合"人数"：操作=对行计数
6. 确定

结果：
```
部门      平均工资    人数
销售部    8500        10
技术部    12000       15
行政部    7000        5
```

进阶：多列分组+多聚合
```
分组：部门、城市
聚合：
- 工资总和
- 最高工资
- 最低工资
- 员工数
```

{{< /tabs >}}

**高级功能**：

**1. 条件列**：

添加列 → 条件列

示例：根据年龄分类
```
如果 [年龄] < 30 则 "年轻"
否则如果 [年龄] < 50 则 "中年"
否则 "资深"
```

**2. 自定义列**（M语言）：

添加列 → 自定义列

示例：计算年终奖
```M
if [销售额] >= 100000 then [销售额] * 0.1
else if [销售额] >= 50000 then [销售额] * 0.05
else 0
```

**3. 数据透视/逆透视**：

**逆透视**（宽表→长表）：
```
原始：
姓名  Q1    Q2    Q3    Q4
张三  100   120   110   130

逆透视后：
姓名  季度  销售额
张三  Q1    100
张三  Q2    120
张三  Q3    110
张三  Q4    130

步骤：
1. 选中"姓名"列
2. 转换 → 逆透视其他列
3. 重命名"属性"列为"季度"，"值"列为"销售额"
```

**透视列**（长表→宽表）：
```
转换 → 透视列
值列：选择要透视的列
值：选择聚合方式
高级选项：值聚合函数
```

**4. 合并查询**（类似VLOOKUP）：

示例：订单表关联客户表

步骤：
1. 加载订单表和客户表到Power Query
2. 在订单表中：主页 → 合并查询
3. 选择客户表
4. 匹配列：订单表的"客户ID" = 客户表的"客户ID"
5. 连接类型：左外部（保留订单表所有行）
6. 确定后，展开新列，选择需要的字段

连接类型：
- **左外部**：保留左表所有行（=SQL LEFT JOIN）
- **右外部**：保留右表所有行
- **完全外部**：保留两表所有行（=FULL OUTER JOIN）
- **内部**：只保留匹配行（=INNER JOIN）
- **左反**：只保留左表独有行
- **右反**：只保留右表独有行

**5. 参数化查询**：

创建动态筛选条件

步骤：
1. 主页 → 管理参数 → 新建参数
2. 名称：StartDate，类型：日期，当前值：2024-01-01
3. 在查询中引用参数：
   - 筛选日期列 → 自定义筛选器
   - 大于或等于 → 参数 → StartDate

**6. 数据类型智能识别**：

自动检测：
- 日期：2024-01-01 → 日期
- 数字：123 → 整数
- 文本：ABC → 文本

手动修改：
- 选中列 → 转换 → 数据类型 → 选择类型

常见类型：
- 整数、十进制数、货币
- 日期、时间、日期时间
- 文本、True/False

**实战案例：销售数据清洗流程**：

原始数据问题：
- 多个月份Excel文件
- 列名不统一
- 包含汇总行
- 日期格式混乱
- 金额包含"¥"符号

完整步骤：
1. **合并文件**：从文件夹加载所有文件
2. **删除汇总行**：筛选器 → 删除包含"合计"的行
3. **标准化列名**：重命名列确保一致
4. **清理金额列**：
   - 替换值："¥" → ""
   - 替换值："," → ""
   - 更改类型：十进制数
5. **标准化日期**：
   - 更改类型：日期
   - 错误处理：替换错误值为null或删除行
6. **添加计算列**：
   - 月份：`Date.Month([日期])`
   - 季度：`Date.QuarterOfYear([日期])`
   - 星期几：`Date.DayOfWeek([日期])`
7. **数据验证**：
   - 检查重复：分组依据 → 对行计数
   - 统计缺失：添加条件列标记空值
8. **关闭并加载**：加载到Excel或数据模型

**性能优化**：

1. **仅加载需要的列**：删除无用列
2. **提前筛选**：在Power Query中过滤，减少数据量
3. **禁用类型检测**：大文件可禁用自动检测类型
4. **查询折叠**：利用数据源性能（SQL、数据库）
5. **避免复杂M语言**：优先使用内置功能

**刷新数据**：

Power Query可保存清洗步骤，数据更新后一键刷新：

1. 右键查询 → 刷新
2. 或：数据 → 全部刷新

**常见问题**：

❌ 步骤错误 → 在"应用的步骤"中删除或修改错误步骤
❌ 列类型自动转换错误 → 手动更改类型并将错误替换为null
❌ 合并查询无结果 → 检查匹配列数据类型是否一致
❌ M语言报错 → 检查语法，参考公式栏示例

{{< /details >}}

{{< details "**如何使用INDEX+MATCH替代VLOOKUP？**" "Excel" >}}

INDEX+MATCH组合比VLOOKUP更灵活强大，支持左侧查找和动态列。

**基础语法**：

```excel
=INDEX(返回范围, MATCH(查找值, 查找范围, 0))

示例：
=INDEX($E$2:$E$10, MATCH(A2, $D$2:$D$10, 0))
```

**与VLOOKUP对比**：

| 特性 | VLOOKUP | INDEX+MATCH |
|------|---------|-------------|
| 查找方向 | 只能向右查找 | 任意方向 |
| 插入列影响 | 需要修改列号 | 不受影响 |
| 性能 | 较慢（扫描整行） | 较快（只查指定列） |
| 灵活性 | 低 | 高 |

**实战案例**：

{{< tabs "向左查找,双向查找,多条件查找,动态范围" >}}

**场景1：向左查找（VLOOKUP做不到）**

表格结构：
```
A列: 员工姓名    B列: 员工编号(要查找)
C列: 查找编号    D列: 返回姓名
```

公式：
```excel
=INDEX($A$2:$A$100, MATCH(C2, $B$2:$B$100, 0))
```

说明：根据编号(在右侧B列)查找姓名(在左侧A列)

|||

**场景2：双向查找（行列交叉）**

表格结构（成绩表）：
```
       A       B      C      D
1            语文   数学   英语
2  张三      85     90     88
3  李四      92     87     91
```

查找张三的数学成绩：
```excel
=INDEX($B$2:$D$3, 
       MATCH("张三", $A$2:$A$3, 0),    # 行号
       MATCH("数学", $B$1:$D$1, 0))    # 列号
```

可变公式（查找单元格F2中的学生，G2中的科目）：
```excel
=INDEX($B$2:$D$3, 
       MATCH(F2, $A$2:$A$3, 0), 
       MATCH(G2, $B$1:$D$1, 0))
```

|||

**场景3：多条件查找**

需求：根据部门+职位查找薪资

表格结构：
```
A列: 部门    B列: 职位    C列: 薪资
```

辅助列法（在D列创建辅助列）：
```excel
# D2单元格：
=A2&"-"&B2

# E2查找公式：
=INDEX($C$2:$C$100, 
       MATCH(F2&"-"&G2, $D$2:$D$100, 0))
```

数组公式法（不需辅助列，Ctrl+Shift+Enter）：
```excel
=INDEX($C$2:$C$100, 
       MATCH(1, ($A$2:$A$100=F2)*($B$2:$B$100=G2), 0))
```

或使用SUMIFS简化多条件：
```excel
=SUMIFS($C$2:$C$100, 
        $A$2:$A$100, F2, 
        $B$2:$B$100, G2)
```

|||

**场景4：动态范围（OFFSET结合）**

需求：查找最后一次出现的值

```excel
# 查找最后一个非空值
=INDEX($A$2:$A$100, 
       COUNTA($A$2:$A$100))

# 查找最后一个匹配项
=INDEX($B$2:$B$100, 
       MAX(IF($A$2:$A$100=F2, ROW($A$2:$A$100)-ROW($A$2)+1)))
# 数组公式，需Ctrl+Shift+Enter
```

{{< /tabs >}}

**进阶技巧**：

**1. 近似匹配（有序数据）**

```excel
# 查找小于等于查找值的最大值（成绩等级）
=INDEX($B$2:$B$6, 
       MATCH(A2, $A$2:$A$6, 1))  # 1表示近似匹配

示例数据：
A列(分数阈值)  B列(等级)
90            优秀
80            良好
70            中等
60            及格
0             不及格
```

**2. 查找部分匹配（通配符）**

```excel
# 模糊查找包含"北京"的项
=INDEX($B$2:$B$100, 
       MATCH("*北京*", $A$2:$A$100, 0))
```

**3. 区分大小写查找**

```excel
# 普通MATCH不区分大小写，使用EXACT数组公式
=INDEX($B$2:$B$100, 
       MATCH(TRUE, EXACT($A$2:$A$100, F2), 0))
```

**4. 错误处理**

```excel
# 使用IFERROR防止#N/A错误
=IFERROR(
    INDEX($B$2:$B$100, MATCH(A2, $A$2:$A$100, 0)), 
    "未找到"
)

# 或使用IFNA（仅捕获#N/A错误）
=IFNA(
    INDEX($B$2:$B$100, MATCH(A2, $A$2:$A$100, 0)), 
    "未找到"
)
```

**性能优化**：

1. **固定查找范围**：使用绝对引用($)固定范围
2. **减小查找区域**：只查找必要的列，不查整行
3. **避免嵌套过多**：复杂情况考虑辅助列
4. **使用命名区域**：提高可读性和性能

```excel
# 定义名称：员工列表 = $A$2:$A$100
# 公式更清晰：
=INDEX(员工列表, MATCH(F2, 编号列表, 0))
```

{{< /details >}}

{{< details "**如何使用COUNTIF/COUNTIFS进行条件计数？**" "Excel" >}}

条件计数函数用于统计满足特定条件的单元格数量。

**COUNTIF语法**：

```excel
=COUNTIF(范围, 条件)

示例：
=COUNTIF(A2:A100, ">80")        # 大于80的数量
=COUNTIF(B2:B100, "北京")       # 等于"北京"的数量
=COUNTIF(C2:C100, "张*")        # 以"张"开头的数量
```

**COUNTIFS语法（多条件）**：

```excel
=COUNTIFS(条件范围1, 条件1, 条件范围2, 条件2, ...)

示例：
=COUNTIFS($A$2:$A$100, ">=80", $A$2:$A$100, "<90")  # 80-90之间
=COUNTIFS($B$2:$B$100, "北京", $C$2:$C$100, "销售")  # 北京且销售部门
```

**常用条件写法**：

```excel
# 数值条件
">80"           # 大于80
">=60"          # 大于等于60
"<>0"           # 不等于0
"="&A1          # 等于单元格A1的值
">="&A1         # 大于等于A1

# 文本条件
"张三"          # 完全匹配
"张*"           # 以"张"开头（*表示任意字符）
"*有限公司"     # 以"有限公司"结尾
"*北京*"        # 包含"北京"
"???"           # 恰好3个字符（?表示单个字符）

# 日期条件
">="&DATE(2024,1,1)              # 2024年1月1日及之后
">"&TODAY()-7                    # 最近7天
">="&EOMONTH(TODAY(),-1)+1       # 本月
```

**实战案例**：

{{< tabs "基础统计,区间统计,文本统计,日期统计,动态条件" >}}

**场景1：销售数据统计**

数据结构：
```
A列: 销售额    B列: 区域    C列: 销售员
```

统计公式：
```excel
# 销售额大于10000的订单数
=COUNTIF($A$2:$A$100, ">10000")

# 北京区域的订单数
=COUNTIF($B$2:$B$100, "北京")

# 北京区域且销售额>10000的订单数
=COUNTIFS($B$2:$B$100, "北京", $A$2:$A$100, ">10000")

# 张三在北京的订单数
=COUNTIFS($B$2:$B$100, "北京", $C$2:$C$100, "张三")

# 统计张三或李四的订单数（使用SUM+COUNTIF）
=COUNTIF($C$2:$C$100, "张三") + COUNTIF($C$2:$C$100, "李四")
```

|||

**场景2：成绩分段统计**

```excel
# 优秀（>=90）
=COUNTIF($A$2:$A$50, ">=90")

# 良好（80-89）
=COUNTIFS($A$2:$A$50, ">=80", $A$2:$A$50, "<90")

# 及格（60-79）
=COUNTIFS($A$2:$A$50, ">=60", $A$2:$A$50, "<80")

# 不及格（<60）
=COUNTIF($A$2:$A$50, "<60")

# 汇总表格式
| 等级 | 分数段 | 人数 |
|------|--------|------|
| 优秀 | >=90   | =COUNTIF($A$2:$A$50,">=90") |
| 良好 | 80-89  | =COUNTIFS($A$2:$A$50,">=80",$A$2:$A$50,"<90") |
| 中等 | 70-79  | =COUNTIFS($A$2:$A$50,">=70",$A$2:$A$50,"<80") |
| 及格 | 60-69  | =COUNTIFS($A$2:$A$50,">=60",$A$2:$A$50,"<70") |
| 不及格 | <60  | =COUNTIF($A$2:$A$50,"<60") |
```

|||

**场景3：文本模糊统计**

```excel
# 统计包含"有限公司"的单位数量
=COUNTIF($A$2:$A$100, "*有限公司*")

# 统计以"138"开头的手机号数量
=COUNTIF($B$2:$B$100, "138*")

# 统计姓张的人数
=COUNTIF($C$2:$C$100, "张*")

# 统计3个字的姓名数量
=COUNTIF($C$2:$C$100, "???")

# 排除包含"测试"的记录数量
=COUNTA($A$2:$A$100) - COUNTIF($A$2:$A$100, "*测试*")
```

|||

**场景4：日期范围统计**

```excel
# 统计本月数据量
=COUNTIFS($A$2:$A$1000, ">="&DATE(YEAR(TODAY()),MONTH(TODAY()),1), 
          $A$2:$A$1000, "<"&DATE(YEAR(TODAY()),MONTH(TODAY())+1,1))

# 或使用EOMONTH
=COUNTIFS($A$2:$A$1000, ">="&EOMONTH(TODAY(),-1)+1, 
          $A$2:$A$1000, "<="&EOMONTH(TODAY(),0))

# 统计最近7天数据量
=COUNTIF($A$2:$A$1000, ">="&TODAY()-7)

# 统计2024年数据量
=COUNTIFS($A$2:$A$1000, ">="&DATE(2024,1,1), 
          $A$2:$A$1000, "<="&DATE(2024,12,31))

# 统计上季度数据量
=COUNTIFS($A$2:$A$1000, ">="&DATE(YEAR(TODAY()),MONTH(TODAY())-3,1), 
          $A$2:$A$1000, "<"&DATE(YEAR(TODAY()),MONTH(TODAY()),1))
```

|||

**场景5：动态条件（引用单元格）**

```excel
# 条件在单元格F2和G2中
=COUNTIFS($B$2:$B$100, F2, $C$2:$C$100, G2)

# 范围条件（最小值在F2，最大值在G2）
=COUNTIFS($A$2:$A$100, ">="&F2, $A$2:$A$100, "<="&G2)

# 动态日期范围（开始日期F2，结束日期G2）
=COUNTIFS($A$2:$A$1000, ">="&F2, $A$2:$A$1000, "<="&G2)

# 多条件OR逻辑（部门是F2或F3）
=COUNTIF($B$2:$B$100, F2) + COUNTIF($B$2:$B$100, F3)

# 使用下拉列表的动态条件
# 在F2设置数据验证（列表：全部,北京,上海,广州）
=IF(F2="全部", 
    COUNTA($B$2:$B$100), 
    COUNTIF($B$2:$B$100, F2))
```

{{< /tabs >}}

**进阶技巧**：

**1. 统计唯一值数量**

```excel
# 使用SUMPRODUCT统计唯一值
=SUMPRODUCT(1/COUNTIF($A$2:$A$100,$A$2:$A$100))

# 去除空值的唯一值统计
=SUMPRODUCT(($A$2:$A$100<>"")/COUNTIF($A$2:$A$100,$A$2:$A$100&""))
```

**2. 统计不重复的条件值**

```excel
# 统计北京有多少个不同的销售员
=SUMPRODUCT(($B$2:$B$100="北京")/COUNTIFS($C$2:$C$100,$C$2:$C$100,$B$2:$B$100,"北京"))
```

**3. 复杂OR条件**

```excel
# 统计部门为销售或市场的数量
=COUNTIF($A$2:$A$100,"销售") + COUNTIF($A$2:$A$100,"市场")

# 使用SUMPRODUCT实现多OR条件
=SUMPRODUCT((($A$2:$A$100="销售")+($A$2:$A$100="市场"))>0)
```

**4. 排除多个条件**

```excel
# 统计不是北京也不是上海的数量
=COUNTA($B$2:$B$100) 
 - COUNTIF($B$2:$B$100,"北京") 
 - COUNTIF($B$2:$B$100,"上海")

# 或使用SUMPRODUCT
=SUMPRODUCT(($B$2:$B$100<>"北京")*($B$2:$B$100<>"上海"))
```

{{< /details >}}

{{< details "**如何使用数组公式进行批量计算？**" "Excel" >}}

数组公式可以同时对多个值进行计算，是Excel的高级功能。

**数组公式基础**：

- **输入方式**：编写公式后按 `Ctrl` + `Shift` + `Enter`
- **显示特征**：公式两侧会显示花括号 `{}`（不能手动输入）
- **Excel 365**：动态数组会自动溢出，不需要Ctrl+Shift+Enter

**基础示例**：

```excel
# 传统方法：逐行计算
A1*B1, A2*B2, A3*B3, ...

# 数组公式：一次计算整列
{=A1:A10*B1:B10}
# 结果会自动填充到10行
```

**实战案例**：

{{< tabs "多条件求和,提取唯一值,动态排序,条件最大值" >}}

**场景1：多条件求和（不使用SUMIFS）**

数据结构：
```
A列: 部门    B列: 产品    C列: 销售额
```

公式（查找销售部门+产品A的总额）：
```excel
{=SUM((A2:A100="销售")*(B2:B100="产品A")*(C2:C100))}
```

解释：
- `(A2:A100="销售")` 返回 TRUE/FALSE 数组
- `(B2:B100="产品A")` 返回 TRUE/FALSE 数组
- 相乘后 TRUE=1, FALSE=0
- 最后与销售额相乘并求和

等价的SUMIFS写法：
```excel
=SUMIFS(C2:C100, A2:A100, "销售", B2:B100, "产品A")
```

|||

**场景2：提取唯一值列表（Excel 2019前）**

```excel
# 提取A列的唯一值到B列
# B1公式：
{=IFERROR(INDEX($A$2:$A$100, 
          MATCH(0, COUNTIF($B$1:B1, $A$2:$A$100), 0)), "")}

# 向下拖动B2, B3, ...
```

Excel 365更简单的方法：
```excel
=UNIQUE(A2:A100)
# 自动返回唯一值数组
```

|||

**场景3：动态提取Top N**

提取前3名的销售额及对应销售员：

```excel
# 提取第N大的值（N在E列）
# F1公式（提取销售额）：
{=LARGE($C$2:$C$100, E1)}

# G1公式（提取对应销售员）：
{=INDEX($A$2:$A$100, 
        MATCH(F1, $C$2:$C$100, 0))}

# 或使用数组公式一次完成：
{=INDEX($A$2:$A$100, 
        MATCH(LARGE($C$2:$C$100, ROW(A1)), 
              $C$2:$C$100, 0))}
# 向下拖动可得Top1, Top2, Top3...
```

Excel 365方法：
```excel
=SORT(A2:C100, 3, -1)  # 按第3列降序排序
# 或
=FILTER(A2:B100, C2:C100>=LARGE(C2:C100,3))  # 筛选前3名
```

|||

**场景4：多条件查找（返回多个结果）**

需求：查找所有属于"销售部"的员工姓名

传统数组公式：
```excel
# 第一个结果
{=INDEX($A$2:$A$100, 
        SMALL(IF($B$2:$B$100="销售部", ROW($A$2:$A$100)-ROW($A$2)+1), 
              ROW(A1)))}

# 向下拖动得到第2、3、4...个结果
# 当没有更多结果时显示错误，用IFERROR包裹
{=IFERROR(INDEX($A$2:$A$100, 
                SMALL(IF($B$2:$B$100="销售部", ROW($A$2:$A$100)-ROW($A$2)+1), 
                      ROW(A1))), "")}
```

Excel 365动态数组：
```excel
=FILTER(A2:A100, B2:B100="销售部")
# 自动返回所有匹配结果
```

{{< /tabs >}}

**常用数组函数**：

**1. 统计函数**

```excel
# 统计满足多条件的数量
{=SUM((A2:A100="条件1")*(B2:B100="条件2"))}

# 计算加权平均
{=SUM(A2:A10*B2:B10)/SUM(B2:B10)}
# A列是数值，B列是权重

# 统计唯一值数量
{=SUM(1/COUNTIF(A2:A100,A2:A100))}
```

**2. 查找函数**

```excel
# 返回最后一个匹配项
{=INDEX(B2:B100, 
        MAX(IF(A2:A100="查找值", ROW(A2:A100)-ROW(A2)+1)))}

# 多条件查找
{=INDEX(C2:C100, 
        MATCH(1, (A2:A100="条件1")*(B2:B100="条件2"), 0))}
```

**3. 文本处理**

```excel
# 批量提取文本（如提取所有单元格的前3个字符）
{=LEFT(A2:A10, 3)}
# Excel 365自动溢出

# 批量连接文本
{=A2:A10&" - "&B2:B10}
```

**4. 条件计算**

```excel
# 根据条件返回不同值
{=IF(A2:A10>100, "高", IF(A2:A10>50, "中", "低"))}
# Excel 365自动溢出

# 批量舍入
{=ROUND(A2:A10, 2)}
```

**Excel 365动态数组函数**：

**FILTER - 筛选**

```excel
# 基础筛选
=FILTER(A2:C100, B2:B100="销售")

# 多条件筛选（AND）
=FILTER(A2:C100, (B2:B100="销售")*(C2:C100>10000))

# 多条件筛选（OR）
=FILTER(A2:C100, (B2:B100="销售")+(B2:B100="市场"))

# 未找到时返回默认值
=FILTER(A2:C100, B2:B100="XX", "未找到匹配项")
```

**SORT - 排序**

```excel
# 按第3列降序排序
=SORT(A2:C100, 3, -1)

# 多列排序（先按第2列升序，再按第3列降序）
=SORT(A2:C100, {2,3}, {1,-1})
```

**SORTBY - 按其他列排序**

```excel
# 按销售额排序员工表
=SORTBY(A2:B100, C2:C100, -1)
# A:B是姓名和部门，C是销售额
```

**UNIQUE - 去重**

```excel
# 提取唯一值
=UNIQUE(A2:A100)

# 提取多列唯一组合
=UNIQUE(A2:C100)

# 只返回出现一次的值
=UNIQUE(A2:A100, FALSE, TRUE)
```

**SEQUENCE - 生成序列**

```excel
# 生成1到10
=SEQUENCE(10)

# 生成3行4列矩阵
=SEQUENCE(3, 4)

# 生成10到100，步长10
=SEQUENCE(10, 1, 10, 10)
```

**数组公式调试技巧**：

1. **F9键调试**：选中公式的一部分，按F9查看计算结果
2. **FORMULATEXT查看公式**：`=FORMULATEXT(A1)` 显示A1的公式文本
3. **分步构建**：先写简单公式，逐步添加条件
4. **使用辅助列**：复杂数组公式先用辅助列验证逻辑

**性能注意事项**：

- ❌ 避免在大数据集上使用易失性函数（INDIRECT、OFFSET）
- ✅ 优先使用SUMIFS、COUNTIFS等内置函数
- ✅ 将数组公式应用范围限制在必要范围
- ✅ Excel 365的FILTER/SORT比传统数组公式性能更好

{{< /details >}}

{{< details "**如何使用TEXT和格式化函数处理数据？**" "Excel" >}}

TEXT函数和格式化功能可以将数值、日期等转换为特定格式的文本。

**TEXT函数基础**：

```excel
=TEXT(值, 格式代码)

示例：
=TEXT(12345, "0.00")          # 12345.00
=TEXT(0.85, "0%")              # 85%
=TEXT(TODAY(), "yyyy-mm-dd")   # 2024-01-15
```

**常用格式代码**：

{{< tabs "数字格式,日期格式,时间格式,自定义格式" >}}

**数字格式代码**：

```excel
# 小数位数
=TEXT(1234.5, "0")           # 1235（四舍五入）
=TEXT(1234.5, "0.0")         # 1234.5
=TEXT(1234.5, "0.00")        # 1234.50
=TEXT(1234.567, "0.00")      # 1234.57

# 千分位分隔符
=TEXT(1234567, "#,##0")      # 1,234,567
=TEXT(1234567.89, "#,##0.00") # 1,234,567.89

# 百分比
=TEXT(0.85, "0%")            # 85%
=TEXT(0.8567, "0.00%")       # 85.67%

# 货币符号
=TEXT(1234.5, "¥#,##0.00")   # ¥1,234.50
=TEXT(1234.5, "$#,##0.00")   # $1,234.50

# 科学计数法
=TEXT(1234567, "0.00E+00")   # 1.23E+06

# 正负数不同格式
=TEXT(1234, "#,##0;(#,##0)") # 1,234
=TEXT(-1234, "#,##0;(#,##0)") # (1,234)

# 前导零
=TEXT(5, "000")              # 005
=TEXT(42, "0000")            # 0042
```

|||

**日期格式代码**：

```excel
# 年份
=TEXT(TODAY(), "yyyy")       # 2024（4位年份）
=TEXT(TODAY(), "yy")         # 24（2位年份）

# 月份
=TEXT(TODAY(), "mm")         # 01（2位月份）
=TEXT(TODAY(), "m")          # 1（1位月份）
=TEXT(TODAY(), "mmm")        # Jan（英文缩写）
=TEXT(TODAY(), "mmmm")       # January（英文全称）
=TEXT(TODAY(), "mmmmm")      # J（首字母）

# 日期
=TEXT(TODAY(), "dd")         # 15（2位日期）
=TEXT(TODAY(), "d")          # 15（1位日期）
=TEXT(TODAY(), "ddd")        # Mon（星期缩写）
=TEXT(TODAY(), "dddd")       # Monday（星期全称）

# 常用组合
=TEXT(TODAY(), "yyyy-mm-dd")         # 2024-01-15
=TEXT(TODAY(), "yyyy/mm/dd")         # 2024/01/15
=TEXT(TODAY(), "yyyy年mm月dd日")     # 2024年01月15日
=TEXT(TODAY(), "m/d/yyyy")           # 1/15/2024
=TEXT(TODAY(), "dd-mmm-yyyy")        # 15-Jan-2024
=TEXT(TODAY(), "dddd, mmmm dd, yyyy") # Monday, January 15, 2024
```

|||

**时间格式代码**：

```excel
# 时分秒
=TEXT(NOW(), "hh:mm:ss")     # 14:30:25（24小时制）
=TEXT(NOW(), "h:mm AM/PM")   # 2:30 PM（12小时制）
=TEXT(NOW(), "hh:mm")        # 14:30

# 日期+时间
=TEXT(NOW(), "yyyy-mm-dd hh:mm:ss")  # 2024-01-15 14:30:25
=TEXT(NOW(), "m/d/yyyy h:mm AM/PM")  # 1/15/2024 2:30 PM

# 时长格式（小时数可能>24）
=TEXT(0.75, "[h]:mm")        # 18:00（0.75天=18小时）
=TEXT(1.5, "[h]:mm")         # 36:00（1.5天=36小时）
```

|||

**自定义格式（包含条件）**：

```excel
# 格式：正数格式;负数格式;零值格式;文本格式
=TEXT(100, "#,##0;(#,##0);零;@")    # 100
=TEXT(-100, "#,##0;(#,##0);零;@")   # (100)
=TEXT(0, "#,##0;(#,##0);零;@")      # 零

# 不同数值范围显示不同颜色（仅单元格格式有效，TEXT不支持颜色）
# 单元格格式：[蓝色][>=100]#,##0;[红色][<0](#,##0);#,##0

# 隐藏某类值
=TEXT(100, "#,##0;#,##0;")   # 零值显示为空
=TEXT(0, "#,##0;#,##0;")     # 空

# 添加文字说明
=TEXT(85, "成绩：0分")        # 成绩：85分
=TEXT(1.5, "0.0米")           # 1.5米
```

{{< /tabs >}}

**实战案例**：

**1. 构造工号/订单号**：

```excel
# 构造6位工号（前导零）
=TEXT(ROW(), "000000")  # 000001, 000002, ...

# 构造订单号（日期+序号）
=TEXT(TODAY(), "yyyymmdd")&TEXT(ROW(), "0000")
# 结果：202401150001

# 带前缀的编号
="EMP-"&TEXT(A2, "00000")  # EMP-00001
="ORD-"&TEXT(TODAY(), "yyyymmdd")&"-"&TEXT(A2, "000")
# 结果：ORD-20240115-001
```

**2. 提取和组合日期部分**：

```excel
# 提取年月
=TEXT(A2, "yyyy-mm")  # 2024-01

# 季度标识
="Q"&TEXT(A2, "q")&"-"&TEXT(A2, "yyyy")  # Q1-2024

# 中文日期
=TEXT(A2, "yyyy年m月d日")  # 2024年1月15日

# 周次
="第"&WEEKNUM(A2)&"周"  # 第3周
```

**3. 数值格式化显示**：

```excel
# 将小数转为百分比文本
=TEXT(A2, "0.00%")  # A2=0.856 → 85.60%

# 财务格式
=TEXT(A2, "¥#,##0.00;¥-#,##0.00")  # ¥12,345.67 或 ¥-12,345.67

# 保留有效数字
=TEXT(A2, "0.00E+00")  # 科学计数法
```

**4. 文本拼接**：

```excel
# 构造完整句子
="销售额："&TEXT(A2, "¥#,##0.00")&"，增长率："&TEXT(B2, "0.00%")
# 结果：销售额：¥12,345.67，增长率：15.30%

# 动态文件名
=TEXT(TODAY(), "yyyy-mm-dd")&"_销售报表.xlsx"
# 结果：2024-01-15_销售报表.xlsx
```

**5. 条件格式化**：

```excel
# 根据数值范围显示不同文本
=IF(A2>=90, "优秀："&TEXT(A2, "0.0"), 
   IF(A2>=60, "及格："&TEXT(A2, "0.0"), 
      "不及格："&TEXT(A2, "0.0")))
```

**注意事项**：

1. **TEXT返回文本**：不能直接用于计算
   ```excel
   =TEXT(100, "0")+50  # 错误！TEXT返回的是文本
   =VALUE(TEXT(100, "0"))+50  # 正确：先转回数值
   ```

2. **日期格式mm vs MMM**：
   - `mm` = 月份数字（01, 02）
   - `mmm` = 月份缩写（Jan, Feb）

3. **时间格式h vs [h]**：
   - `h` = 小时（0-23）
   - `[h]` = 总小时数（可>24）

4. **区域设置影响**：不同地区的日期月份名称可能不同

**组合其他函数**：

```excel
# 提取中文星期
=TEXT(A2, "aaaa")  # 星期一（中文系统）

# 提取年龄（从身份证号）
=YEAR(TODAY())-VALUE(MID(A2, 7, 4))  # 身份证号在A2

# 构造SQL查询字符串
="SELECT * FROM orders WHERE date = '"&TEXT(A2, "yyyy-mm-dd")&"'"
```

{{< /details >}}

{{< details "**如何使用LEFT、RIGHT、MID提取文本？**" "Excel" >}}

文本提取函数用于从字符串中获取指定位置和长度的字符。

**基础语法**：

```excel
=LEFT(文本, [字符数])    # 从左侧提取
=RIGHT(文本, [字符数])   # 从右侧提取
=MID(文本, 起始位置, 字符数)  # 从中间提取
```

**基础示例**：

```excel
# 示例文本："Excel2024数据分析"

=LEFT("Excel2024数据分析", 5)     # Excel
=RIGHT("Excel2024数据分析", 4)    # 数据分析
=MID("Excel2024数据分析", 6, 4)   # 2024

# 提取单元格A2的内容
=LEFT(A2, 3)                      # 前3个字符
=RIGHT(A2, 5)                     # 后5个字符
=MID(A2, 4, 6)                    # 从第4个字符开始提取6个
```

**实战案例**：

{{< tabs "身份证号,手机号,地址,文件名,编号" >}}

**场景1：身份证号信息提取**

假设身份证号在A列：`110101199001011234`

```excel
# 提取省份代码（前2位）
=LEFT(A2, 2)  # 11

# 提取市代码（3-4位）
=MID(A2, 3, 2)  # 01

# 提取区代码（5-6位）
=MID(A2, 5, 2)  # 01

# 提取出生年份（7-10位）
=MID(A2, 7, 4)  # 1990

# 提取出生月份（11-12位）
=MID(A2, 11, 2)  # 01

# 提取出生日期（13-14位）
=MID(A2, 13, 2)  # 01

# 完整出生日期
=TEXT(DATE(MID(A2,7,4), MID(A2,11,2), MID(A2,13,2)), "yyyy-mm-dd")
# 1990-01-01

# 性别判断（倒数第2位，奇数=男，偶数=女）
=IF(MOD(MID(A2, 17, 1), 2)=1, "男", "女")

# 年龄计算
=YEAR(TODAY())-MID(A2, 7, 4)
```

|||

**场景2：手机号脱敏处理**

手机号：`13812345678`

```excel
# 中间4位脱敏
=LEFT(A2, 3)&"****"&RIGHT(A2, 4)
# 结果：138****5678

# 保留前3后2
=LEFT(A2, 3)&"******"&RIGHT(A2, 2)
# 结果：138******78

# 分段显示
=LEFT(A2, 3)&"-"&MID(A2, 4, 4)&"-"&RIGHT(A2, 4)
# 结果：138-1234-5678
```

|||

**场景3：地址拆分**

地址：`北京市朝阳区建国路100号`

```excel
# 提取省/直辖市（前2-3个字符）
# 方法1：固定长度
=LEFT(A2, 3)  # 北京市

# 方法2：查找"省"或"市"
=LEFT(A2, FIND("市", A2))  # 北京市

# 提取区县（查找第二个"市"到"区"之间）
=MID(A2, FIND("市", A2)+1, FIND("区", A2)-FIND("市", A2))
# 朝阳区

# 提取街道+门牌号（"区"之后）
=MID(A2, FIND("区", A2)+1, LEN(A2))
# 建国路100号

# 提取门牌号数字
=LEFT(MID(A2, FIND("路", A2)+1, 10), 
      FIND("号", MID(A2, FIND("路", A2)+1, 10))-1)
# 100
```

|||

**场景4：文件名处理**

文件名：`2024-01-15_销售报表_V1.2.xlsx`

```excel
# 提取日期部分
=LEFT(A2, 10)  # 2024-01-15

# 提取文件主名（去除扩展名）
=LEFT(A2, FIND(".", A2)-1)
# 2024-01-15_销售报表_V1.2

# 提取扩展名
=RIGHT(A2, LEN(A2)-FIND(".", A2))
# xlsx
# 或
=MID(A2, FIND(".", A2)+1, LEN(A2))

# 提取版本号
=MID(A2, FIND("_V", A2)+2, FIND(".", A2, FIND("_V", A2))-FIND("_V", A2)-2)
# 1.2

# 更复杂：按"_"拆分提取第2部分
=MID(A2, FIND("_", A2)+1, 
     FIND("_", A2, FIND("_", A2)+1)-FIND("_", A2)-1)
# 销售报表
```

|||

**场景5：产品编号拆分**

编号：`PRD-2024-001-BJ`

```excel
# 提取前缀
=LEFT(A2, 3)  # PRD

# 提取年份
=MID(A2, 5, 4)  # 2024

# 提取序号
=MID(A2, 10, 3)  # 001

# 提取地区代码
=RIGHT(A2, 2)  # BJ

# 或使用分隔符"-"查找
=LEFT(A2, FIND("-", A2)-1)  # PRD（第一部分）

# 提取第2部分（第1个"-"到第2个"-"之间）
=MID(A2, FIND("-", A2)+1, 
     FIND("-", A2, FIND("-", A2)+1)-FIND("-", A2)-1)
# 2024
```

{{< /tabs >}}

**组合函数使用**：

**1. 与FIND/SEARCH结合（动态位置）**：

```excel
# 提取@前面的用户名（邮箱）
=LEFT(A2, FIND("@", A2)-1)
# alice@gmail.com → alice

# 提取@后面的域名
=MID(A2, FIND("@", A2)+1, LEN(A2))
# alice@gmail.com → gmail.com

# 提取最后一个空格前的内容
=LEFT(A2, FIND("~", SUBSTITUTE(A2, " ", "~", LEN(A2)-LEN(SUBSTITUTE(A2, " ", ""))))-1)
```

**2. 与LEN结合（相对长度）**：

```excel
# 提取后半部分
=RIGHT(A2, LEN(A2)/2)

# 提取中间部分（去掉首尾各2个字符）
=MID(A2, 3, LEN(A2)-4)
```

**3. 数值提取**：

```excel
# 从文本"价格：￥1234.50"中提取数字
=VALUE(MID(A2, FIND("￥", A2)+1, LEN(A2)))
# 或
=--MID(A2, FIND("￥", A2)+1, LEN(A2))  # --是将文本转数字的技巧

# 提取字符串中的所有数字（数组公式）
{=SUM(--MID(A2, ROW(INDIRECT("1:"&LEN(A2))), 1)*10^(LEN(A2)-ROW(INDIRECT("1:"&LEN(A2)))))}
```

**4. 中英文混合处理**：

```excel
# 注意：中文字符也占1个字符位
="你好世界ABC"
=LEFT(A1, 2)  # 你好
=RIGHT(A1, 3)  # ABC

# LENB统计字节数（中文占2字节）
=LENB("你好世界")  # 8
=LEN("你好世界")   # 4
```

**常见错误处理**：

```excel
# 找不到分隔符时返回错误
=LEFT(A2, FIND("@", A2)-1)  # 如果没有@会报错

# 使用IFERROR处理
=IFERROR(LEFT(A2, FIND("@", A2)-1), A2)
# 找不到@时返回原文本

# 或使用IFNA（仅处理#N/A错误）
=IFNA(LEFT(A2, FIND("@", A2)-1), A2)
```

**性能优化技巧**：

```excel
# 避免多次计算相同的FIND
# 差
=MID(A2, FIND("@", A2)+1, FIND(".", A2, FIND("@", A2))-FIND("@", A2)-1)

# 好：使用辅助列存储FIND结果
# B2: =FIND("@", A2)
# C2: =FIND(".", A2, B2)
# D2: =MID(A2, B2+1, C2-B2-1)

# 或使用LET函数（Excel 365）
=LET(
    at_pos, FIND("@", A2),
    dot_pos, FIND(".", A2, at_pos),
    MID(A2, at_pos+1, dot_pos-at_pos-1)
)
```

{{< /details >}}

{{< details "**如何使用数据验证（下拉列表）？**" "Excel" >}}

数据验证用于限制单元格输入内容，确保数据准确性和规范性。

**创建基础下拉列表**：

1. 选中目标单元格
2. 数据 → 数据验证 → 数据验证
3. 允许：列表
4. 来源：输入选项（逗号分隔）或引用区域

**方法1：直接输入选项**：

```
验证条件：列表
来源：男,女,其他
```

优点：简单快捷
缺点：选项固定，不易维护

**方法2：引用单元格区域**：

```
来源：=$G$2:$G$10
```

说明：
- 在G2:G10输入选项列表
- 使用绝对引用($)
- 可隐藏G列或放在其他工作表

优点：选项可维护，修改G列即可
缺点：需要占用单元格

**方法3：使用定义名称**：

步骤：
1. 选中G2:G10
2. 公式 → 定义名称 → 输入"部门列表"
3. 数据验证来源：=部门列表

优点：公式更清晰，易于管理
缺点：需要额外定义名称

**实战案例**：

{{< tabs "二级联动,动态选项,条件限制,自定义输入" >}}

**场景1：二级联动下拉列表**

需求：选择省份后，城市列表自动更新

步骤：

1. **准备数据**：
```
H列（省份）    I列（城市）
北京          北京市
北京          通州区
北京          朝阳区
上海          上海市
上海          浦东新区
上海          黄浦区
```

2. **创建省份下拉（A2单元格）**：
```
数据验证来源：北京,上海,广州
# 或引用唯一省份列表
```

3. **创建动态城市列表（B2单元格）**：
```
数据验证来源：=INDIRECT(A2)
```

**但需要先为每个省份创建命名范围**：

- 选中"北京市,通州区,朝阳区"，定义名称为"北京"
- 选中"上海市,浦东新区,黄浦区"，定义名称为"上海"

**更灵活的方法（使用FILTER，Excel 365）**：

```
数据验证来源：=FILTER($I$2:$I$20, $H$2:$H$20=A2)
```

|||

**场景2：动态扩展的下拉列表**

需求：选项列表会不断增加

方法1：使用动态命名区域
```
名称管理器定义：
名称：动态列表
引用位置：=OFFSET(Sheet1!$G$2,0,0,COUNTA(Sheet1!$G:$G)-1,1)
```

数据验证来源：`=动态列表`

方法2：使用表格（推荐）
1. 选中G1:G20
2. 插入 → 表 → 勾选"表包含标题"
3. 数据验证来源：`=Table1[部门]`

优点：自动扩展，无需公式维护

|||

**场景3：条件限制（不同行不同选项）**

需求：
- A列"类型"选择"收入"时，B列只能选收入类别
- A列选择"支出"时，B列只能选支出类别

设置B2单元格验证：
```
数据验证来源：=IF($A2="收入", 收入列表, 支出列表)
```

其中"收入列表"和"支出列表"是预定义的命名区域。

或使用CHOOSE：
```
=CHOOSE(MATCH($A2,{"收入","支出"},0), 
        $G$2:$G$5,    # 收入选项
        $H$2:$H$8)    # 支出选项
```

|||

**场景4：允许自定义输入**

需求：提供常用选项，但允许输入其他值

**方法：不使用数据验证，用VBA或公式提示**

或使用"提示信息"功能：
1. 数据验证 → 输入信息
2. 标题：常用选项
3. 输入信息：财务部,人力部,技术部（或输入其他）

注意：这只是提示，不强制限制

**真正允许自定义的变通方法**：
1. 不设验证，使用条件格式标记非标准值
2. 条件格式公式：`=NOT(COUNTIF(标准列表, A2))`
3. 格式：黄色背景（提醒但不阻止）

{{< /tabs >}}

**其他验证类型**：

**1. 数字范围**：

```
允许：整数
数据：介于
最小值：1
最大值：100
```

或使用公式：
```
允许：自定义
公式：=AND(A2>=1, A2<=100, MOD(A2,1)=0)
```

**2. 文本长度**：

```
允许：文本长度
数据：等于
长度：18  # 身份证号必须18位
```

或：
```
允许：自定义
公式：=LEN(A2)=18
```

**3. 日期范围**：

```
允许：日期
数据：介于
开始日期：=TODAY()
结束日期：=TODAY()+30  # 只能选未来30天
```

**4. 唯一值（不重复）**：

```
允许：自定义
公式：=COUNTIF($A$2:$A$100, A2)<=1
```

**5. 手机号格式**：

```
允许：自定义
公式：=AND(LEN(A2)=11, LEFT(A2,1)="1", ISNUMBER(--A2))
```

**6. 邮箱格式**：

```
允许：自定义
公式：=AND(ISERROR(FIND(" ", A2)), LEN(A2)-LEN(SUBSTITUTE(A2,"@",""))=1, FIND("@", A2)>1, FIND(".", A2, FIND("@", A2))>FIND("@", A2)+1)
```

**提示信息设置**：

```
输入信息标签：
标题：请选择部门
输入信息：从列表中选择您所属的部门，或留空

出错警告标签：
样式：停止/警告/信息
标题：输入错误
错误信息：请从下拉列表中选择，或输入1-100之间的整数
```

样式区别：
- **停止**：完全阻止无效输入（图标：❌）
- **警告**：提示但可选择继续（图标：⚠）
- **信息**：仅提示不阻止（图标：ℹ）

**批量应用验证**：

1. 设置第一个单元格的验证
2. 复制该单元格（Ctrl+C）
3. 选中目标区域
4. 选择性粘贴 → 验证

或：
1. 选中目标区域（包括已设验证的）
2. 数据 → 数据验证
3. 勾选"将设置应用于其他相同设置的单元格"

**清除验证**：

1. 选中单元格
2. 数据 → 数据验证
3. 全部清除

**查找包含验证的单元格**：

1. 开始 → 查找和选择 → 定位条件
2. 选择"数据验证" → 全部/相同
3. 确定

**常见问题**：

1. **下拉箭头不显示**：检查是否勾选"提供下拉箭头"
2. **INDIRECT不工作**：确保命名区域名称没有空格或特殊字符
3. **验证失效**：复制粘贴可能覆盖验证，使用"选择性粘贴-数值"
4. **动态列表不更新**：使用表格或OFFSET公式确保范围动态扩展

{{< /details >}}

{{< details "**如何使用日期时间函数进行计算？**" "Excel" >}}

Excel的日期时间函数是数据分析中的核心技能，掌握它们能高效处理时间序列数据。

**基础日期时间函数**：

```excel
-- 当前日期时间
=TODAY()                    # 2024-01-15（仅日期）
=NOW()                      # 2024-01-15 14:30:25（日期+时间）

-- 构造日期时间
=DATE(2024, 1, 15)          # 2024-01-15
=TIME(14, 30, 0)            # 14:30:00（0.604166，实际是小数）
=DATEVALUE("2024-01-15")    # 将文本转日期
=TIMEVALUE("14:30:00")      # 将文本转时间

-- 提取日期部分
=YEAR(A1)                   # 提取年份：2024
=MONTH(A1)                  # 提取月份：1
=DAY(A1)                    # 提取日期：15
=HOUR(A1)                   # 提取小时：14
=MINUTE(A1)                 # 提取分钟：30
=SECOND(A1)                 # 提取秒数：25

-- 星期处理
=WEEKDAY(A1)                # 1-7（1=周日，7=周六）
=WEEKDAY(A1, 2)             # 1-7（1=周一，7=周日）
=TEXT(A1, "aaaa")           # 星期一/Monday
=TEXT(A1, "aaa")            # 周一/Mon
=WEEKNUM(A1)                # 返回第几周
```

**日期格式化（TEXT函数）**：

{{< tabs "日期格式,时间格式,自定义格式,中文格式" >}}

**日期格式代码**：

```excel
=TEXT(A1, "yyyy-mm-dd")              # 2024-01-15
=TEXT(A1, "yyyy年mm月dd日")           # 2024年01月15日
=TEXT(A1, "m/d/yyyy")                # 1/15/2024
=TEXT(A1, "mmm dd, yyyy")            # Jan 15, 2024
=TEXT(A1, "mmmm dd, yyyy")           # January 15, 2024
=TEXT(A1, "dddd, mmmm dd, yyyy")     # Monday, January 15, 2024

# 格式符号说明：
# yyyy: 4位年份    yy: 2位年份
# mm: 2位月份      m: 1位月份
# mmm: 月份缩写    mmmm: 月份全称
# dd: 2位日期      d: 1位日期
# dddd: 星期全称   ddd: 星期缩写
```

|||

**时间格式代码**：

```excel
=TEXT(A1, "hh:mm:ss")                # 14:30:25（24小时制）
=TEXT(A1, "hh:mm AM/PM")             # 02:30 PM（12小时制）
=TEXT(A1, "h:mm")                    # 14:30（不补零）
=TEXT(A1, "[h]:mm")                  # 总小时数（超过24小时显示）

# 格式符号说明：
# hh: 2位小时（24小时制）   h: 1位小时
# mm: 2位分钟               m: 1位分钟
# ss: 2位秒                 s: 1位秒
# [h]: 累计小时数（不归零）
```

|||

**组合与自定义**：

```excel
=TEXT(A1, "yyyy-mm-dd hh:mm:ss")     # 2024-01-15 14:30:25
=TEXT(A1, "yyyy/mm/dd (aaaa)")       # 2024/01/15 (星期一)
=TEXT(A1, "mm月dd日 hh时mm分")        # 01月15日 14时30分

# 条件格式化（不同值显示不同格式）
=TEXT(A1, "[>0]正数;[<0]负数;零")
=TEXT(A1, "[蓝色]yyyy-mm-dd")        # 带颜色
```

|||

**中文日期处理**：

```excel
=TEXT(A1, "yyyy年m月d日")            # 2024年1月15日
=TEXT(A1, "aaaa")                    # 星期一
=TEXT(A1, "[$-zh-CN]aaaa")           # 星期一（强制中文）
=TEXT(A1, "yyyy年第w周")              # 2024年第3周

# 农历（需要特定函数或插件）
# Excel原生不支持农历，需借助第三方加载项
```

{{< /tabs >}}

**日期计算与运算**：

{{< tabs "日期加减,日期差值,工作日计算,月末处理" >}}

**日期加减运算**：

```excel
-- 基本加减（日期是数字，1 = 1天）
=A1 + 7                      # 加7天
=A1 - 30                     # 减30天
=A1 + 1/24                   # 加1小时（1天÷24）
=A1 + 30/1440                # 加30分钟（1天÷1440）

-- 使用 DATE 函数精确加减
=DATE(YEAR(A1), MONTH(A1) + 1, DAY(A1))      # 加1个月
=DATE(YEAR(A1) + 1, MONTH(A1), DAY(A1))      # 加1年
=DATE(YEAR(A1), MONTH(A1), DAY(A1) + 7)      # 加7天

-- 处理月末溢出
=EDATE(A1, 1)                # 加1个月（自动处理月末）
=EDATE(A1, -12)              # 减12个月（即去年同期）
=EOMONTH(A1, 0)              # 当月最后一天
=EOMONTH(A1, 1)              # 下月最后一天
```

|||

**日期差值计算**：

```excel
-- 简单相减（返回天数）
=B1 - A1                     # 日期差（天数）

-- DAYS 函数
=DAYS(B1, A1)                # 结束日期 - 开始日期

-- DATEDIF 函数（隐藏函数，强大但文档少）
=DATEDIF(A1, B1, "d")        # 天数差
=DATEDIF(A1, B1, "m")        # 完整月数差
=DATEDIF(A1, B1, "y")        # 完整年数差
=DATEDIF(A1, B1, "ym")       # 月数差（忽略年）
=DATEDIF(A1, B1, "md")       # 天数差（忽略月和年）
=DATEDIF(A1, B1, "yd")       # 天数差（忽略年）

-- 计算年龄（精确）
=DATEDIF(生日, TODAY(), "y")                     # 完整年龄
=DATEDIF(生日, TODAY(), "y") & "岁" & 
 DATEDIF(生日, TODAY(), "ym") & "个月"           # 25岁3个月

-- 时间差计算（小时/分钟）
=(B1 - A1) * 24              # 小时差
=(B1 - A1) * 1440            # 分钟差
=(B1 - A1) * 86400           # 秒数差
```

|||

**工作日计算（排除周末和节假日）**：

```excel
-- WORKDAY：加N个工作日
=WORKDAY(A1, 5)              # 5个工作日后（排除周六日）
=WORKDAY(A1, 10, H2:H10)     # 10个工作日后（排除指定节假日）
=WORKDAY(A1, -5)             # 5个工作日前

-- WORKDAY.INTL：自定义周末
=WORKDAY.INTL(A1, 10, 1)     # 周六日为周末（默认）
=WORKDAY.INTL(A1, 10, 2)     # 周日/周一为周末
=WORKDAY.INTL(A1, 10, 7)     # 仅周日为周末
=WORKDAY.INTL(A1, 10, "0000011")  # 自定义：周六日为周末

-- NETWORKDAYS：计算两日期间工作日数
=NETWORKDAYS(A1, B1)         # 工作日天数（排除周六日）
=NETWORKDAYS(A1, B1, H2:H10) # 工作日天数（排除节假日）
=NETWORKDAYS.INTL(A1, B1, 1) # 自定义周末的工作日计算

-- 实战：计算项目工期
=NETWORKDAYS(项目开始日期, 项目结束日期, 节假日表)
```

|||

**月末月初与季度处理**：

```excel
-- 月初
=DATE(YEAR(A1), MONTH(A1), 1)                     # 当月第一天
=EOMONTH(A1, -1) + 1                              # 当月第一天（另一种方法）

-- 月末
=EOMONTH(A1, 0)                                   # 当月最后一天
=DATE(YEAR(A1), MONTH(A1) + 1, 0)                 # 当月最后一天（另一种方法）
=EOMONTH(A1, 1)                                   # 下月最后一天
=EOMONTH(A1, -1)                                  # 上月最后一天

-- 判断是否月末
=A1 = EOMONTH(A1, 0)                              # TRUE/FALSE

-- 当月天数
=DAY(EOMONTH(A1, 0))                              # 28/29/30/31

-- 季度处理
=ROUNDUP(MONTH(A1) / 3, 0)                        # 返回季度（1-4）
="Q" & ROUNDUP(MONTH(A1) / 3, 0)                  # Q1/Q2/Q3/Q4
=QUARTER(A1)                                      # 季度（Excel 365）

-- 季度初/季度末
=DATE(YEAR(A1), (ROUNDUP(MONTH(A1)/3, 0) - 1) * 3 + 1, 1)  # 季度初
=EOMONTH(A1, (ROUNDUP(MONTH(A1)/3, 0) * 3) - MONTH(A1))    # 季度末
```

{{< /tabs >}}

**实战场景应用**：

**场景1：计算员工入职天数和工龄**：

```excel
# A2: 入职日期
=DATEDIF(A2, TODAY(), "d") & "天"                           # 入职总天数
=DATEDIF(A2, TODAY(), "y") & "年" & 
 DATEDIF(A2, TODAY(), "ym") & "月"                          # 1年3个月
=NETWORKDAYS(A2, TODAY())                                   # 工作日数
```

**场景2：生成日期序列（用于月报/周报）**：

```excel
# 生成连续日期（从A1开始往下拖拽公式）
=A1 + 1                                    # 每天+1
=DATE(YEAR(A1), MONTH(A1) + 1, 1)          # 每月1日
=A1 + 7                                    # 每周

# SEQUENCE函数（Excel 365）
=SEQUENCE(30, 1, TODAY(), 1)               # 从今天开始30天序列
=SEQUENCE(12, 1, DATE(2024,1,1), 30)       # 每月1日（12个月）
```

**场景3：计算账期和逾期天数**：

```excel
# A2: 订单日期   B2: 账期天数（如30天）  C2: 还款日期
=A2 + B2                                   # 应还款日期
=IF(C2 > A2 + B2, C2 - (A2 + B2), 0)       # 逾期天数
=IF(TODAY() > A2 + B2, TODAY() - (A2 + B2), 0)  # 当前逾期天数
```

**场景4：按月/季度汇总数据（数据透视表配合）**：

```excel
# 提取年月（用于分组）
=TEXT(A2, "yyyy-mm")                       # 2024-01
=YEAR(A2) & "-Q" & ROUNDUP(MONTH(A2)/3, 0) # 2024-Q1

# SUMIFS按月统计
=SUMIFS(金额列, 日期列, ">=" & DATE(2024,1,1), 日期列, "<" & DATE(2024,2,1))
```

**场景5：计算同比/环比**：

```excel
# 去年同期（同比）
=DATE(YEAR(A2) - 1, MONTH(A2), DAY(A2))    # 去年同一天
=EDATE(A2, -12)                            # 去年同月

# 上个月（环比）
=DATE(YEAR(A2), MONTH(A2) - 1, DAY(A2))
=EDATE(A2, -1)

# 同比增长率
=(本期金额 - VLOOKUP(去年同期日期, 历史表, 金额列, 0)) / 
  VLOOKUP(去年同期日期, 历史表, 金额列, 0)
```

**场景6：判断节假日和工作日**：

```excel
# 判断是否周末
=WEEKDAY(A2, 2) > 5                        # TRUE=周末
=IF(WEEKDAY(A2,2)>5, "周末", "工作日")

# 判断是否法定节假日
=COUNTIF(节假日表, A2) > 0                  # TRUE=节假日

# 综合判断
=IF(OR(WEEKDAY(A2,2)>5, COUNTIF(节假日表,A2)>0), "休息日", "工作日")
```

**场景7：提取动态时间段数据**：

```excel
# 本月数据
=AND(A2>=DATE(YEAR(TODAY()), MONTH(TODAY()), 1),
     A2<=EOMONTH(TODAY(), 0))

# 最近7天
=AND(A2>=TODAY()-7, A2<=TODAY())

# 本季度
=AND(ROUNDUP(MONTH(A2)/3,0) = ROUNDUP(MONTH(TODAY())/3,0),
     YEAR(A2) = YEAR(TODAY()))
```

**常见错误与解决**：

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| `#VALUE!` | 日期格式错误（文本） | 用 `DATEVALUE()` 转换或检查单元格格式 |
| `#NUM!` | 日期超出范围（1900-9999） | 检查输入数据 |
| 日期显示为数字（45326） | 单元格格式非日期 | 右键 → 设置单元格格式 → 日期 |
| DATEDIF返回负数 | 开始日期晚于结束日期 | 交换参数或加绝对值 `ABS()` |
| 月末日期不对 | 跨月计算溢出 | 使用 `EDATE()` 或 `EOMONTH()` 代替加减 |

**Excel日期系统注意事项**：

1. **Excel日期本质是数字**：1900-01-01 = 1，每天+1
2. **时间是小数**：1小时 = 1/24 = 0.041667
3. **1900闰年Bug**：Excel错误地将1900年当闰年（兼容Lotus 1-2-3）
4. **不同系统**：Windows（1900系统）vs Mac（1904系统）可能导致日期差异
5. **文本vs日期**：从CSV导入的"2024-01-15"可能是文本，需转换
6. **格式保留**：复制粘贴时使用"选择性粘贴-值"避免格式问题

{{< /details >}}

